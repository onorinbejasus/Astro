// Generated by CoffeeScript 1.3.2
var SkyView,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

SkyView = (function(_super) {

  __extends(SkyView, _super);

  SkyView.gridBlocks = 0;

  SkyView.rotation = null;

  SkyView.translation = null;

  SkyView.renderMode = 0;

  SkyView.Math = null;

  SkyView.it = 0;

  SkyView.selected = "none";

  function SkyView(options) {
    this.mousePress = __bind(this.mousePress, this);

    this.keyPressed = __bind(this.keyPressed, this);

    this.render = __bind(this.render, this);

    this.setLevel = __bind(this.setLevel, this);

    this.setRotation = __bind(this.setRotation, this);

    this.setScale = __bind(this.setScale, this);
    SkyView.__super__.constructor.call(this, options);
    this.translation = [0.0, 0.0, 0.3333];
    this.rotation = [-52.0, -176.0, 0.0];
    this.renderMode = this.gl.TRIANGLES;
    this.level = 0;
    this.Math = new math();
    this.gridBlocks = [];
    document.getElementById("scale").value = 1. * 3600;
    this.render(true);
    return;
  }

  SkyView.prototype.setScale = function() {
    return this.translation[2] = 1 - (document.getElementById("scale").value / 45.0);
  };

  SkyView.prototype.setRotation = function() {
    this.rotation[1] = parseFloat(document.getElementById("RA").value);
    return this.rotation[0] = parseFloat(document.getElementById("Dec").value);
  };

  SkyView.prototype.setLevel = function() {
    return this.level = parseInt(document.getElementById("level").value);
  };

  SkyView.prototype.render = function(flag) {
    var dec, grid, ra, radius, _i, _len, _ref,
      _this = this;
    if ((flag != null) && flag === true) {
      radius = parseFloat(document.getElementById("scale").value) / 60.0;
      if (radius < 1.0) {
        radius = 1.0;
      }
      ra = parseFloat(document.getElementById("RA").value);
      dec = parseFloat(document.getElementById("Dec").value);
      $.ajaxSetup({
        'async': false
      });
      $.getJSON("./SDSSFieldQuery.php?ra=" + ra + "&dec=" + dec + "&radius=				" + radius + "&zoom=0", function(data) {
        return $.each(data, function(key, val) {
          console.log(val);
          return _this.gridBlocks.push(new HTM(_this.level, _this.gl, _this.Math, "sky", "./sdss/" + val));
        });
      });
      $.ajaxSetup({
        'async': true
      });
    }
    this.preRender(this.rotation, this.translation);
    console.log(this.gridBlocks.size);
    _ref = this.gridBlocks;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      grid = _ref[_i];
      if (grid.getSet() === true) {
        console.log("render");
        grid.bindSphere(this.shaderProgram);
        grid.renderSphere(this.renderMode);
      }
    }
  };

  SkyView.prototype.keyPressed = function(key) {
    switch (String.fromCharCode(key.which)) {
      case 'i':
        this.rotation[0] -= 0.1;
        document.getElementById("Dec").value = -this.rotation[0];
        this.render();
        break;
      case 'k':
        this.rotation[0] += 0.1;
        document.getElementById("Dec").value = -this.rotation[0];
        this.render();
        break;
      case 'l':
        this.rotation[1] += 0.1;
        document.getElementById("RA").value = -this.rotation[1];
        if (document.getElementById("RA").value < 0) {
          document.getElementById("RA").value = 360 - this.rotation[1];
        } else if (document.getElementById("RA").value > 360) {
          document.getElementById("RA").value = this.rotation[1] - 360;
        }
        this.render();
        break;
      case 'j':
        this.rotation[1] -= 0.1;
        document.getElementById("RA").value = -this.rotation[1];
        if (document.getElementById("RA").value > 360) {
          document.getElementById("RA").value = this.rotation[1] - 360;
        } else if (document.getElementById("RA").value < 0) {
          document.getElementById("RA").value = 360 - this.rotation[1];
        }
        this.render();
        break;
      case 'p':
        this.rotation[1] += 1.0;
        document.getElementById("RA").value = -this.rotation[1];
        if (document.getElementById("RA").value < 0) {
          document.getElementById("RA").value = 360 - this.rotation[1];
        } else if (document.getElementById("RA").value > 360) {
          document.getElementById("RA").value = this.rotation[1] - 360;
        }
        this.render();
        break;
      case 'o':
        this.rotation[1] -= 1.0;
        document.getElementById("RA").value = -this.rotation[1];
        if (document.getElementById("RA").value > 360) {
          document.getElementById("RA").value = this.rotation[1] - 360;
        } else if (document.getElementById("RA").value < 0) {
          document.getElementById("RA").value = 360 - this.rotation[1];
        }
        this.render();
        break;
      case 'w':
        this.translation[2] += 0.001;
        this.render(false);
        break;
      case 's':
        this.translation[2] -= 0.001;
        this.render();
        break;
      case 'W':
        this.translation[2] += 0.01;
        this.render(false);
        break;
      case 'S':
        this.translation[2] -= 0.01;
        this.render();
        break;
      case 'x':
        this.translation[0] -= 0.001;
        this.render();
        break;
      case 'X':
        this.translation[0] += 0.001;
        this.render();
        break;
      case 'y':
        this.translation[1] -= 0.001;
        this.render();
        break;
      case 'Y':
        this.translation[1] += 0.001;
        this.render();
        break;
      case '1':
        this.level = 1;
        document.getElementById('level').value = 1;
        document.getElementById("scale").value = 180.0 / Math.pow(2, this.level + 1);
        this.render();
        break;
      case '2':
        this.level = 2;
        document.getElementById('level').value = 2;
        document.getElementById("scale").value = 180.0 / Math.pow(2, this.level + 1);
        this.render();
        break;
      case '3':
        this.level = 3;
        document.getElementById('level').value = 3;
        document.getElementById("scale").value = 180.0 / Math.pow(2, this.level + 1);
        this.render();
        break;
      case '4':
        this.level = 4;
        document.getElementById('level').value = 4;
        document.getElementById("scale").value = 180.0 / Math.pow(2, this.level + 1);
        this.render();
        break;
      case '5':
        this.level = 5;
        document.getElementById('level').value = 5;
        document.getElementById("scale").value = 180.0 / Math.pow(2, this.level + 1);
        this.render();
        break;
      case '6':
        this.level = 6;
        document.getElementById('level').value = 6;
        document.getElementById("scale").value = 180.0 / Math.pow(2, this.level + 1);
        this.render();
        break;
      case '7':
        this.level = 7;
        document.getElementById('level').value = 7;
        document.getElementById("scale").value = 180.0 / Math.pow(2, this.level + 1);
        this.render();
        break;
      case '8':
        this.level = 8;
        document.getElementById('level').value = 8;
        document.getElementById("scale").value = 180.0 / Math.pow(2, this.level + 1);
        this.render();
        break;
      case '9':
        this.level = 9;
        document.getElementById('level').value = 9;
        document.getElementById("scale").value = 180.0 / Math.pow(2, this.level + 1);
        this.render();
        break;
      case '0':
        this.level = 0;
        document.getElementById('level').value = 0;
        document.getElementById("scale").value = 180.0 / Math.pow(2, this.level + 1);
        this.render();
        break;
      case 'r':
        console.log(this.rotation);
        console.log(this.translation);
    }
  };

  SkyView.prototype.mousePress = function(key) {
    var dir, far, inverse, matrices, names, near, origin, success, tri;
    if (key.x > 500 || key.y > 500) {
      return;
    }
    matrices = this.getMatrices();
    near = [];
    far = [];
    success = GLU.unProject(key.x, this.gl.viewportHeight - key.y, 0.0, matrices[0], matrices[1], matrices[2], near);
    success = GLU.unProject(key.x, this.gl.viewportHeight - key.y, 1.0, matrices[0], matrices[1], matrices[2], far);
    dir = this.Math.subtract(far, near);
    origin = [0.0, 0.0, 0.0, 1.0];
    inverse = mat4.set(matrices[0], mat4.create());
    inverse = mat4.inverse(inverse);
    origin = this.Math.multiply(origin, inverse);
    dir = this.Math.norm(dir);
    tri = this.HTM.getTriangles();
    names = this.HTM.getNames();
    /*		
    		it = -1
    		for triangle in tri
    			it = it + 1
    			if @Math.intersectTri(origin, dir, triangle)
    				console.log names[it]
    				@selected = names[it]
    				this.render()
    				this.colorClick(triangle)
    				break
    */

  };

  return SkyView;

})(WebGL);
